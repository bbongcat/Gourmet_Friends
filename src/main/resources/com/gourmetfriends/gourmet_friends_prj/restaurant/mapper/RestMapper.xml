<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gourmetfriends.gourmet_friends_prj.restaurant.mapper.RestMapper">

    <resultMap id="RestMap" type="com.gourmetfriends.gourmet_friends_prj.restaurant.domain.Rest">
        <result property="restNo" column="rest_no"/>
        <result property="cateNo" column="cate_no"/>
        <result property="restName" column="rest_name"/>
        <result property="restPh" column="rest_ph"/>
        <result property="restStar" column="rest_star"/>
        <result property="restTime" column="rest_time"/>
        <result property="restPhoto" column="rest_photo"/>
        <result property="restCnt" column="rest_cnt"/>
    </resultMap>

    <select id="getRestList" resultMap="RestMap">
        SELECT *
        FROM restaurant
        WHERE rest_no > 0
        ORDER BY rest_no DESC
    </select>

    <select id="getListWithPaging" resultMap="RestMap">
        <![CDATA[
        SELECT rest_no,
               cate_no,
               rest_name,
               rest_ph,
               rest_star,
               rest_time,
               rest_photo,
               rest_cnt
        FROM (
                 SELECT rownum rn,
                        rest_no,
                        cate_no,
                        rest_name,
                        rest_ph,
                        rest_star,
                        rest_time,
                        rest_photo,
                        rest_cnt
                 FROM restaurant
                 WHERE rownum <= #{page} * #{amount}
             )
        WHERE rn > (#{page} - 1) * #{amount}
        ]]>
    </select>

    <!-- 식당이름으로 식당 검색 기능 -->
    <select id="getListByRestName" resultMap="RestMap">
        <![CDATA[
        SELECT rest_no,
               cate_no,
               rest_name,
               rest_ph,
               rest_star,
               rest_time,
               rest_photo,
               rest_cnt
        FROM (
                 SELECT rownum rn,
                        rest_no,
                        cate_no,
                        rest_name,
                        rest_ph,
                        rest_star,
                        rest_time,
                        rest_photo,
                        rest_cnt
                 FROM restaurant
                 WHERE rest_name like '%' || #{keyword} || '%'
                   AND rownum <= #{page} * #{amount}
             )
        WHERE rn > (#{page} - 1) * #{amount}
        ]]>
    </select>

    <!-- 목록 조회 통합 검색 -->
    <select id="getSearchList" resultMap="RestMap">
        <![CDATA[
            SELECT rest_no,cate_no,rest_name,rest_ph,rest_star,rest_time,rest_photo,rest_cnt
            FROM restaurant
            WHERE rest_name
        ]]>
        <if test="type == 'cate_no'">
            cate_no LIKE '%' || #{keyword} || '%' AND
        </if>
        <if test="type == 'rest_name'">
            rest_name LIKE '%' || #{keyword} || '%' AND
        </if>
        <if test="type == 'cateNoRestName'">
            (cate_no LIKE '%' || #{keyword} || '%' OR
            rest_name LIKE '%' || #{keyword} || '%')
        </if>
        <![CDATA[
            ORDER BY rest_no DESC
            LIMIT #{startIndex}, #{amount}
        ]]>
    </select>

    <select id="getSearchTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM restaurant
        <if test="type == 'cate_no'">
            WHERE cate_no LIKE '%' || #{keyword} || '%'
        </if>
        <if test="type == 'rest_no'">
            WHERE rest_no LIKE '%' || #{keyword} || '%'
        </if>
        <if test="type == 'cateNoRestName'">
            WHERE (cate_no LIKE '%' || #{keyword} || '%' OR
            rest_name LIKE '%' || #{keyword} || '%')
        </if>
    </select>

    <select id="findByRestNo" resultMap="RestMap">
        SELECT *
        FROM restaurant
        WHERE rest_no = #{restNo}
    </select>

    <insert id="restSave">
        INSERT INTO restaurant
            (rest_no, cate_no, rest_name, rest_ph,rest_star,rest_time,rev_cnt)
            VALUE((select * from (select max(rest_no)+1 from restaurant)nextval),#{cateNo},#{restName},#{restPh},#{restStar},#{restTime},#{revCnt})
    </insert>

    <update id="restUpdate">
        UPDATE restaurant
        SET cate_no    = #{cateNo},
            rest_name  = #{restName},
            rest_ph    = #{restPh},
            rest_time  = #{restTime},
            rest_photo = #{restPhoto}
            WHERE rest_no = #{restNo};
    </update>

    <delete id="restDelete">
        DELETE
        FROM restaurant
        WHERE rest_no = #{restNo}
    </delete>

</mapper>