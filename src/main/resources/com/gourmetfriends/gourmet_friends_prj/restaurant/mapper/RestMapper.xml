<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gourmetfriends.gourmet_friends_prj.restaurant.mapper.RestMapper">

    <resultMap id="restMap" type="com.gourmetfriends.gourmet_friends_prj.restaurant.domain.Rest">
        <result property="restNo" column="rest_no"/>
        <result property="cateNo" column="cate_no"/>
        <result property="restName" column="rest_name"/>
        <result property="restPh" column="rest_ph"/>
        <result property="restStar" column="rest_star"/>
        <result property="restTime" column="rest_time"/>
        <result property="restPhoto" column="rest_photo"/>
        <result property="restCnt" column="rest_cnt"/>
    </resultMap>

    <select id="getRestList" resultMap="restMap">
        SELECT *
        FROM restaurant
        WHERE rest_no > 0
        ORDER BY rest_no DESC
    </select>

    <select id="getListWithPaging" resultMap="restMap">
        SELECT rest_no, cate_no, rest_name, rest_ph, rest_star, rest_time,rest_photo, rest_cnt
        FROM restaurant
        ORDER BY rest_no DESC
        LIMIT #{startIndex}, #{amount}
    </select>

    <select id="restGetTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM restaurant
    </select>

    <!-- 식당이름으로 식당 검색 기능 -->
    <select id="restGetListByRestName" resultMap="restMap">
        SELECT rest_no,cate_no,rest_name,rest_ph,rest_star,rest_time,rest_photo,rest_cnt
        FROM restaurant
        WHERE rest_name LIKE CONCAT('%',#{keyword},'%')
        ORDER BY rest_no DESC
        LIMIT #{startIndex} , #{amount}
    </select>

    <select id="restGetTotalCountByRestName" resultType="int">
        SELECT COUNT(*)
        FROM restaurant
        WHERE rest_name LIKE CONCAT('%',#{keyword},'%')
    </select>

    <!-- 목록 조회 통합 검색 -->
    <select id="restGetSearchList" resultMap="restMap">
        <![CDATA[
            SELECT rest_no,cate_no,rest_name,rest_ph,rest_star,rest_time,rest_photo,rest_cnt
            FROM restaurant
        ]]>
            <if test="type == 'restNo'">
                WHERE rest_no LIKE CONCAT('%',#{keyword},'%')
            </if>
            <if test="type == 'cateNo'">
                WHERE cate_no LIKE CONCAT('%',#{keyword},'%')
            </if>
            <if test="type == 'restName'">
                WHERE rest_name LIKE CONCAT('%',#{keyword},'%')
            </if>
        <![CDATA[
            ORDER BY rest_no DESC
            LIMIT #{startIndex}, #{amount}
        ]]>
    </select>

    <select id="restGetSearchTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM restaurant
        <if test="type == 'restNo'">
            WHERE rest_no LIKE CONCAT('%',#{keyword},'%')
        </if>
        <if test="type == 'cateNo'">
            WHERE cate_no LIKE CONCAT('%',#{keyword},'%')
        </if>
        <if test="type == 'restName'">
            WHERE rest_name LIKE CONCAT('%',#{keyword},'%')
        </if>
    </select>

    <select id="findByRestNo" resultMap="restMap">
        SELECT *
        FROM restaurant
        WHERE rest_no = #{restNo}
    </select>

    <insert id="restWrite">
        INSERT INTO restaurant
            (rest_no, cate_no, rest_name, rest_ph,rest_star,rest_time,rev_cnt)
        VALUES (seq_rest.nextval,#{cateNo},#{restName},#{restPh},#{restStar},#{restTime},#{revCnt})
    </insert>

    <update id="restUpdate">
        UPDATE restaurant
        SET cate_no    = #{cateNo},
            rest_name  = #{restName},
            rest_ph    = #{restPh},
            rest_time  = #{restTime},
            rest_photo = #{restPhoto}
        WHERE rest_no = #{restNo};
    </update>

    <!-- 수정 해야하는 것 - 포토 첨부 처리-->
    <select id="addRestPhoto">
        INSERT INTO rest_upload
            (rest_photo,rest_no)
        VALUES (#{restPhoto},seq_rest.nextval)
    </select>

    <!-- 포토명 조회 -->
    <select id="findRestPhoto" resultType="string">
        SELECT rest_photo
        FROM rest_upload
        WHERE rest_no = #{restNo}
    </select>

    <delete id="restDelete">
        DELETE
        FROM restaurant
        WHERE rest_no = #{restNo}
    </delete>

</mapper>